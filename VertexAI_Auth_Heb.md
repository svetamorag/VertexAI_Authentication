# אימות ל-Vertex AI: הבנה מעמיקה ושיקולי הגבלות

אימות (Authentication) ל-Vertex AI הוא תהליך חיוני לאימות זהות הגורם המגיש בקשה, בין אם מדובר במשתמש או ביישום. זהו תנאי מקדים להרשאה (Authorization), הקובעת אילו משאבים הישות המאומתת רשאית לגשת אליהם ומהי רמת הגישה שלה (למשל, קריאה, כתיבה, מחיקה). Google Cloud משתמש ב-Identity and Access Management (IAM) לצורך הרשאה, וחשוב להבין את ההבדל בין אימות להרשאה כדי לאבחן בעיות גישה.

ניתן לבצע אימות מול Vertex AI באמצעות ממשקים ושיטות שונות, התלויות בסביבת הרצת הקוד ובכלים שבהם נעשה שימוש. הדרך המרכזית שבה ספריות לקוח של Google Cloud (המומלצות לאינטראקציה עם Vertex AI) מוצאות אישורים היא באמצעות **Application Default Credentials (ADC)**. ADC היא אסטרטגיה המאפשרת לספריות האימות למצוא אישורים באופן אוטומטי בהתבסס על סביבת היישום. הדבר מאפשר לקוד לרוץ בסביבות שונות (פיתוח מקומי, ייצור) מבלי לשנות את אופן האימות שלו. בקשות REST יכולות גם להשתמש ב-ADC.

## כיצד ADC מחפש אישורים:
הוא מחפש אישורים לפי הסדר הבא:


* משתנה הסביבה `GOOGLE_APPLICATION_CREDENTIALS`: יכול להפנות לקובץ JSON המכיל אישורים (למשל, קובץ תצורת Federation, או מפתח חשבון שירות).
* קובץ אישורים שנוצר באמצעות הפקודה `gcloud auth application-default login`.
* חשבון השירות המצורף: מושג משרת המטא-דאטה.

## הגבלות ושיקולים של כל דרך אימות באמצעות ADC:

ההגבלות והשיקולים של כל דרך לאימות תלויים במקור האישורים שבו משתמשים, לרוב באמצעות ADC:

### שימוש באישורי משתמש באמצעות `gcloud auth application-default login` (מומלץ לפיתוח מקומי):

* **אופן פעולה:** פקודה זו מאמתת את חשבון המשתמש ומאחסנת אישורים בקובץ JSON מקומי שבו ADC משתמש. זה מאפשר לספריות הלקוח למצוא ולהשתמש באישורים אלו אוטומטית בסביבת הפיתוח המקומית.
* **הגבלות/שיקולים:** שיטה זו **אינה מתאימה לסביבות ייצור**. כברירת מחדל, אסימוני הגישה שנוצרים כוללים את היקף ההרשאה הרחב `https://www.googleapis.com/auth/cloud-platform`, המספק גישה נרחבת ולעתים קרובות יותר הרשאות ממה שהיישום דורש בפועל. ניתן להשתמש בדגל `--scopes` כדי להגביל את ההרשאות.
* **מקרה שימוש אידיאלי:** פיתוח מהיר, בדיקות מקומיות על תחנת עבודה.

---
### שימוש בקובץ מפתח חשבון שירות (חלופה לפיתוח מקומי או CI/CD מחוץ ל-GCP):

* **אופן פעולה:** קובץ JSON המכיל אישורים עבור חשבון שירות. ניתן לספק קובץ זה ל-ADC על ידי הגדרת משתנה הסביבה `GOOGLE_APPLICATION_CREDENTIALS` לנתיב המוחלט שלו. זה מאפשר בדיקת יישום עם ההרשאות המדויקות של חשבון שירות ספציפי.
* **הגבלות/שיקולים:** מפתחות חשבון שירות מציבים **סיכון אבטחתי משמעותי** אם הם נפגעים. בניגוד לסוגי אישורים אחרים, מפתח גנוב יכול לספק גישה ישירה ללא צורך באימות נוסף. מפתחות חשבון שירות **אסורים בחום לסביבות ייצור** ו**אסור בשום פנים ואופן לשמור אותם בבקרת גרסאות** (כמו Git). הם דורשים ניהול קפדני ואחסון מאובטח. מפתחות הם סטטיים ואינם מתחלפים אוטומטית.
* **מקרה שימוש אידיאלי:** בדיקת הרשאות ספציפיות של חשבון שירות באופן מקומי. תהליכי CI/CD שאינם מתארחים ב-GCP שבהם אין אפשרות לחשבונות שירות מצורפים.

---
### שימוש בחשבון שירות מצורף (מומלץ לייצור ב-Google Cloud):

* **אופן פעולה:** כאשר היישום שלך רץ על משאב Google Cloud (כמו Cloud Run, Compute Engine, GKE), ניתן לצרף חשבון שירות למשאב זה. ADC משתמש בשרת המטא-דאטה כדי לקבל אישורים עבור חשבון שירות מצורף זה. Google Cloud מטפל אוטומטית ברכישה מאובטחת של אסימוני גישה קצרי מועד. זוהי **השיטה המועדפת והמאובטחת ביותר** עבור פריסות ייצור ב-Cloud Run, Compute Engine, GKE ושירותים מנוהלים אחרים ב-GCP. היא מבטלת את הצורך לנהל קבצי מפתחות בתוך הקוד או הקונטיינר.
* **הגבלות/שיקולים:** דורש הגדרת תפקידי IAM נכונה עבור חשבון השירות. עבור רוב השירותים (כולל Cloud Run), יש לצרף את חשבון השירות בעת יצירת המשאב או הפריסה, ובדרך כלל לא ניתן לשנות אותו מאוחר יותר ללא פריסה מחדש.
* **מקרה שימוש אידיאלי:** פריסות ייצור ב-Cloud Run, Compute Engine, GKE ושירותים מנוהלים אחרים ב-GCP.

---
### שימוש באישורים של gcloud CLI:

* **אופן פעולה:** כאשר אתה משתמש ב-gcloud CLI, אתה מתחבר עם חשבון משתמש, המספק את האישורים לביצוע פקודות gcloud. ניתן גם להשתמש בהתחזות לחשבון שירות (Service Account Impersonation) עם ה-gcloud CLI. אישורים אלו נבדלים מאישורי ADC שנוצרו על ידי `gcloud auth application-default login`.
* **הגבלות/שיקולים:** משמש בעיקר לאינטראקציה עם Google Cloud דרך שורת הפקודה. אם מדיניות האבטחה הארגונית מונעת מחשבונות משתמש הרשאות נדרשות, ייתכן שיידרש התחזות לחשבון שירות.
* **מקרה שימוש אידיאלי:** ניהול Vertex AI ומשאבי Google Cloud אחרים משורת הפקודה.

---
### שימוש ב-REST:

* **אופן פעולה:** ניתן לאמת בקשות REST ל-Vertex AI API באמצעות אישורי ה-gcloud CLI (למשל, על ידי הכללת אסימון גישה שהושג באמצעות `gcloud auth print-access-token` בכותרת הבקשה) או באמצעות ADC.
* **הגבלות/שיקולים:** דורש הכללת מידע אימות (כמו אסימון גישה) כחלק מהבקשה.
* **מקרה שימוש אידיאלי:** אינטראקציה תכנותית ישירה עם Vertex AI API או שימוש בכלי שורת פקודה כמו `curl`.

---
### שימוש בהתחזות לחשבון שירות (Service Account Impersonation):

* **אופן פעולה:** מאפשר לישות אחת (כמו משתמש או חשבון שירות אחר) להשיג אישורים עבור חשבון שירות, ובכך לפעול למעשה כחשבון שירות זה. זה דורש מהישות המפעילה את ההרשאה `iam.serviceAccounts.getAccessToken`, הכלולה בתפקיד `roles/iam.serviceAccountTokenCreator`. ניתן להגדיר את ה-gcloud CLI להשתמש בהתחזות או ליצור קובץ ADC מקומי עם התחזות עבור ספריות לקוח מסוימות.
* **הגבלות/שיקולים:** דורש מהישות הקוראת את התפקיד `roles/iam.serviceAccountTokenCreator`. יצירת קובץ ADC מקומי עם התחזות נתמכת רק עבור ספריות הלקוח של Go, Java, Node.js ו-Python—היא **אינה נתמכת עבור שפות אחרות**.
* **מקרה שימוש אידיאלי:** בדיקת ההרשאות שהוקצו לחשבון שירות ספציפי. כאשר מדיניות האבטחה הארגונית מונעת שימוש באישורי משתמש עם ההרשאות הנדרשות.

---
### שימוש ב-Workload Identity Federation או Workforce Identity Federation (בסביבה מקומית או בענן אחר):

* **אופן פעולה:** שיטות אלו מאפשרות לישויות המאומתות על ידי ספק זהויות חיצוני (IdP) לגשת למשאבי Google Cloud ללא צורך במפתחות חשבון שירות. זוהי **השיטה המועדפת לאימות מחוץ ל-Google Cloud**. ניתן להפנות לקובץ תצורת אישורים באמצעות משתנה הסביבה `GOOGLE_APPLICATION_CREDENTIALS`.
* **הגבלות/שיקולים:** כרוך בהגדרת תצורה מורכבת יותר בהשוואה לשיטות המשמשות בתוך Google Cloud.
* **מקרה שימוש אידיאלי:** אימות יישומים או משתמשים הפועלים מחוץ ל-Google Cloud (בסביבה מקומית, ספקי ענן אחרים) ושילוב עם מערכות זהות ארגוניות קיימות.

---
ללא קשר לשיטת האימות שבה נעשה שימוש, הרשאה נכונה באמצעות תפקידי IAM חיונית כדי להבטיח שלישות המאומתת יש את ההרשאות הנדרשות לאינטראקציה עם משאבי Vertex AI. הקפדה על **עקרון ההרשאה המינימלית (Principle of Least Privilege)** – הענקת רק ההרשאות המינימליות הנחוצות – היא נוהג אבטחה קריטי. הימנע מהקצאת תפקידים רחבים מדי כמו "Project Editor" או "Project Owner" לחשבונות שירות בסביבות ייצור. תפקיד **"Vertex AI User"** מספיק לרוב משימות הפיתוח.

לסיכום והשוואה מפורטים יותר בין השיטות ומקרי השימוש האידיאליים שלהן, תוך הדגשת הסיכונים האבטחתיים הכרוכים בשימוש במפתחות חשבון שירות לעומת האבטחה המוגברת של חשבונות שירות מצורפים ב-GCP, ניתן לעיין בתיעוד הרשמי של Google Cloud.
